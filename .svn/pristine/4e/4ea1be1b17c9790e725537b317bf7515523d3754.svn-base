(function(t){if(typeof define==="function"&&define.amd){define(["jquery","ChineseDistricts"],t)}else if(typeof exports==="object"){t(require("jquery"),require("ChineseDistricts"))}else{t(jQuery,ChineseDistricts)}})(function(t,e){"use strict";if(typeof e==="undefined"){throw new Error('The file "city-picker.data.js" must be included first!')}var i="citypicker";var s="change."+i;var n="province";var c="city";var a="district";function o(e,i){this.$element=t(e);this.$dropdown=null;this.options=t.extend({},o.DEFAULTS,t.isPlainObject(i)&&i);this.active=false;this.dems=[];this.needBlur=false;this.init()}o.prototype={constructor:o,init:function(){this.defineDems();this.render();this.bind();this.active=true},render:function(){var e=this.getPosition(),i=this.$element.attr("placeholder")||this.options.placeholder,s='<span class="city-picker-span" style="'+this.getWidthStyle(e.width)+"height:"+e.height+"px;line-height:"+(e.height-1)+'px;">'+(i?'<span class="placeholder">'+i+"</span>":"")+'<span class="title"></span><div class="arrow"></div>'+"</span>",n='<div class="city-picker-dropdown" style="left:0px;top:100%;'+this.getWidthStyle(e.width,true)+'">'+'<div class="city-select-wrap">'+'<div class="city-select-tab">'+'<a class="active" data-count="province">省份</a>'+(this.includeDem("city")?'<a data-count="city">城市</a>':"")+(this.includeDem("district")?'<a data-count="district">区县</a>':"")+"</div>"+'<div class="city-select-content">'+'<div class="city-select province" data-count="province"></div>'+(this.includeDem("city")?'<div class="city-select city" data-count="city"></div>':"")+(this.includeDem("district")?'<div class="city-select district" data-count="district"></div>':"")+"</div></div>";this.$element.addClass("city-picker-input");this.$textspan=t(s).insertAfter(this.$element);this.$dropdown=t(n).insertAfter(this.$textspan);var c=this.$dropdown.find(".city-select");t.each(this.dems,t.proxy(function(t,e){this["$"+e]=c.filter("."+e+"")},this));this.refresh()},refresh:function(e){var i=this.$dropdown.find(".city-select");i.data("item",null);var s=this.$element.val()||"";s=s.split("/");t.each(this.dems,t.proxy(function(t,i){if(s[t]&&t<s.length){this.options[i]=s[t]}else if(e){this.options[i]=""}this.output(i)},this));this.tab(n);this.feedText();this.feedVal()},defineDems:function(){var e=false;t.each([n,c,a],t.proxy(function(t,i){if(!e){this.dems.push(i)}if(i===this.options.level){e=true}},this))},includeDem:function(e){return t.inArray(e,this.dems)!==-1},getPosition:function(){var t,e,i,s,n;t=this.$element.position();s=this.getSize(this.$element);e=s.height;i=s.width;if(this.options.responsive){n=this.$element.offsetParent().width();if(n){i=i/n;if(i>.99){i=1}i=i*100+"%"}}return{top:t.top||0,left:t.left||0,height:e,width:i}},getSize:function(e){var i,s,n;if(!e.is(":visible")){i=t("<div />").appendTo(t("body"));i.css({position:"absolute !important",visibility:"hidden !important",display:"block !important"});s=e.clone().appendTo(i);n={width:s.outerWidth(),height:s.outerHeight()};i.remove()}else{n={width:e.outerWidth(),height:e.outerHeight()}}return n},getWidthStyle:function(e,i){if(this.options.responsive&&!t.isNumeric(e)){return"width:"+e+";"}else{return"width:"+(i?Math.max(320,e):e)+"px;"}},bind:function(){var e=this;t(document).on("click",this._mouteclick=function(i){var s=t(i.target);var n,c,a;if(s.is(".city-picker-span")){c=s}else if(s.is(".city-picker-span *")){c=s.parents(".city-picker-span")}if(s.is(".city-picker-input")){a=s}if(s.is(".city-picker-dropdown")){n=s}else if(s.is(".city-picker-dropdown *")){n=s.parents(".city-picker-dropdown")}if(!a&&!c&&!n||c&&c.get(0)!==e.$textspan.get(0)||a&&a.get(0)!==e.$element.get(0)||n&&n.get(0)!==e.$dropdown.get(0)){e.close(true)}});this.$element.on("change",this._changeElement=t.proxy(function(){this.close(true);this.refresh(true)},this)).on("focus",this._focusElement=t.proxy(function(){this.needBlur=true;this.open()},this)).on("blur",this._blurElement=t.proxy(function(){if(this.needBlur){this.needBlur=false;this.close(true)}},this));this.$textspan.on("click",function(i){var s=t(i.target),n;e.needBlur=false;if(s.is(".select-item")){n=s.data("count");e.open(n)}else{if(e.$dropdown.is(":visible")){e.close()}else{e.open()}}}).on("mousedown",function(){e.needBlur=false});this.$dropdown.on("click",".city-select a",function(){var i=t(this).parents(".city-select");var n=i.find("a.active");var c=i.next().length===0;n.removeClass("active");t(this).addClass("active");if(n.data("code")!==t(this).data("code")){i.data("item",{address:t(this).attr("title"),code:t(this).data("code")});t(this).trigger(s);e.feedText();e.feedVal(true);if(c){e.close()}}}).on("click",".city-select-tab a",function(){if(!t(this).hasClass("active")){var i=t(this).data("count");e.tab(i)}}).on("mousedown",function(){e.needBlur=false});if(this.$province){this.$province.on(s,this._changeProvince=t.proxy(function(){this.output(c);this.output(a);this.tab(c)},this))}if(this.$city){this.$city.on(s,this._changeCity=t.proxy(function(){this.output(a);this.tab(a)},this))}},open:function(t){t=t||n;this.$dropdown.show();this.$textspan.addClass("open").addClass("focus");this.tab(t)},close:function(t){this.$dropdown.hide();this.$textspan.removeClass("open");if(t){this.$textspan.removeClass("focus")}},unbind:function(){t(document).off("click",this._mouteclick);this.$element.off("change",this._changeElement);this.$element.off("focus",this._focusElement);this.$element.off("blur",this._blurElement);this.$textspan.off("click");this.$textspan.off("mousedown");this.$dropdown.off("click");this.$dropdown.off("mousedown");if(this.$province){this.$province.off(s,this._changeProvince)}if(this.$city){this.$city.off(s,this._changeCity)}},getText:function(){var e="";this.$dropdown.find(".city-select").each(function(){var i=t(this).data("item"),s=t(this).data("count");if(i){e+=(t(this).hasClass("province")?"":"/")+'<span class="select-item" data-count="'+s+'" data-code="'+i.code+'">'+i.address+"</span>"}});return e},getPlaceHolder:function(){return this.$element.attr("placeholder")||this.options.placeholder},feedText:function(){var t=this.getText();if(t){this.$textspan.find(">.placeholder").hide();this.$textspan.find(">.title").html(this.getText()).show()}else{this.$textspan.find(">.placeholder").text(this.getPlaceHolder()).show();this.$textspan.find(">.title").html("").hide()}},getCode:function(e){var i={},s=[];this.$textspan.find(".select-item").each(function(){var e=t(this).data("code");var n=t(this).data("count");i[n]=e;s.push(e)});return e?i[e]:s.join("/")},getVal:function(){var e="";this.$dropdown.find(".city-select").each(function(){var i=t(this).data("item");if(i){e+=(t(this).hasClass("province")?"":"/")+i.address}});return e},feedVal:function(t){this.$element.val(this.getVal());if(t){this.$element.trigger("cp:updated")}},output:function(i){var s=this.options;var o=this["$"+i];var r=i===n?{}:[];var d;var h;var l;var f=null;var p;if(!o||!o.length){return}d=o.data("item");p=(d?d.address:null)||s[i];l=i===n?86:i===c?this.$province&&this.$province.find(".active").data("code"):i===a?this.$city&&this.$city.find(".active").data("code"):l;h=t.isNumeric(l)?e[l]:null;if(t.isPlainObject(h)){t.each(h,function(t,e){var s;if(i===n){s=[];for(var c=0;c<e.length;c++){if(e[c].address===p){f={code:e[c].code,address:e[c].address}}s.push({code:e[c].code,address:e[c].address,selected:e[c].address===p})}r[t]=s}else{if(e===p){f={code:t,address:e}}r.push({code:t,address:e,selected:e===p})}})}o.html(i===n?this.getProvinceList(r):this.getList(r,i));o.data("item",f)},getProvinceList:function(e){var i=[],s=this,c=this.options.simple;t.each(e,function(e,a){i.push('<dl class="clearfix">');i.push("<dt>"+e+"</dt><dd>");t.each(a,function(t,e){i.push("<a"+' title="'+(e.address||"")+'"'+' data-code="'+(e.code||"")+'"'+' class="'+(e.selected?" active":"")+'">'+(c?s.simplize(e.address,n):e.address)+"</a>")});i.push("</dd></dl>")});return i.join("")},getList:function(e,i){var s=[],n=this,c=this.options.simple;s.push('<dl class="clearfix"><dd>');t.each(e,function(t,e){s.push("<a"+' title="'+(e.address||"")+'"'+' data-code="'+(e.code||"")+'"'+' class="'+(e.selected?" active":"")+'">'+(c?n.simplize(e.address,i):e.address)+"</a>")});s.push("</dd></dl>");return s.join("")},simplize:function(t,e){t=t||"";if(e===n){return t.replace(/[省,市,自治区,壮族,回族,维吾尔]/g,"")}else if(e===c){return t.replace(/[市,地区,回族,蒙古,苗族,白族,傣族,景颇族,藏族,彝族,壮族,傈僳族,布依族,侗族]/g,"").replace("哈萨克","").replace("自治州","").replace(/自治县/,"")}else if(e===a){return t.length>2?t.replace(/[市,区,县,旗]/g,""):t}},tab:function(t){var e=this.$dropdown.find(".city-select");var i=this.$dropdown.find(".city-select-tab > a");var s=this["$"+t];var n=this.$dropdown.find('.city-select-tab > a[data-count="'+t+'"]');if(s){e.hide();s.show();i.removeClass("active");n.addClass("active")}},reset:function(){this.$element.val(null).trigger("change")},destroy:function(){this.unbind();this.$element.removeData(i).removeClass("city-picker-input");this.$textspan.remove();this.$dropdown.remove()}};o.DEFAULTS={simple:false,responsive:false,placeholder:"请选择省/市/区",level:"district",province:"",city:"",district:""};o.setDefaults=function(e){t.extend(o.DEFAULTS,e)};o.other=t.fn.citypicker;t.fn.citypicker=function(e){var s=[].slice.call(arguments,1);return this.each(function(){var n=t(this);var c=n.data(i);var a;var r;if(!c){if(/destroy/.test(e)){return}a=t.extend({},n.data(),t.isPlainObject(e)&&e);n.data(i,c=new o(this,a))}if(typeof e==="string"&&t.isFunction(r=c[e])){r.apply(c,s)}})};t.fn.citypicker.Constructor=o;t.fn.citypicker.setDefaults=o.setDefaults;t.fn.citypicker.noConflict=function(){t.fn.citypicker=o.other;return this};t(function(){t('[data-toggle="city-picker"]').citypicker()})});