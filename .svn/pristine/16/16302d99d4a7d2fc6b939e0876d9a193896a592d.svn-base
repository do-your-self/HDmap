layui.define(["layer-mobile","zepto"],function(e){"use strict";var a=layui.zepto;var t=layui["layer-mobile"];var i=layui.device();var r="layui-upload-enter";var n="layui-upload-iframe";var o={icon:2,shift:6},s={file:"文件",video:"视频",audio:"音频"};t.msg=function(e){return t.open({content:e||"",skin:"msg",time:2})};var u=function(e){this.options=e};u.prototype.init=function(){var e=this,t=e.options;var i=a("body"),o=a(t.elem||".layui-upload-file");var u=a('<iframe id="'+n+'" class="'+n+'" name="'+n+'"></iframe>');a("#"+n)[0]||i.append(u);return o.each(function(i,o){o=a(o);var u='<form target="'+n+'" method="'+(t.method||"post")+'" key="set-mine" enctype="multipart/form-data" action="'+(t.url||"")+'"></form>';var l=o.attr("lay-type")||t.type;if(!t.unwrap){u='<div class="layui-box layui-upload-button">'+u+'<span class="layui-upload-icon"><i class="layui-icon">&#xe608;</i>'+(o.attr("lay-title")||t.title||"上传"+(s[l]||"图片"))+"</span></div>"}u=a(u);if(!t.unwrap){u.on("dragover",function(e){e.preventDefault();a(this).addClass(r)}).on("dragleave",function(){a(this).removeClass(r)}).on("drop",function(){a(this).removeClass(r)})}if(o.parent("form").attr("target")===n){if(t.unwrap){o.unwrap()}else{o.parent().next().remove();o.unwrap().unwrap()}}o.wrap(u);o.off("change").on("change",function(){e.action(this,l)})})};u.prototype.action=function(e,i){var r=this,s=r.options,u=e.value;var l=a(e),p=l.attr("lay-ext")||s.ext||"";if(!u){return}switch(i){case"file":if(p&&!RegExp("\\w\\.("+p+")$","i").test(escape(u))){t.msg("不支持该文件格式",o);return e.value=""}break;case"video":if(!RegExp("\\w\\.("+(p||"avi|mp4|wma|rmvb|rm|flash|3gp|flv")+")$","i").test(escape(u))){t.msg("不支持该视频格式",o);return e.value=""}break;case"audio":if(!RegExp("\\w\\.("+(p||"mp3|wav|mid")+")$","i").test(escape(u))){t.msg("不支持该音频格式",o);return e.value=""}break;default:if(!RegExp("\\w\\.("+(p||"jpg|png|gif|bmp|jpeg")+")$","i").test(escape(u))){t.msg("不支持该图片格式",o);return e.value=""}break}s.before&&s.before(e);l.parent().submit();var c=a("#"+n),f=setInterval(function(){var a;try{a=c.contents().find("body").text()}catch(e){t.msg("上传接口存在跨域",o);clearInterval(f)}if(a){clearInterval(f);c.contents().find("body").html("");try{a=JSON.parse(a)}catch(e){a={};return t.msg("请对上传接口返回JSON字符",o)}typeof s.success==="function"&&s.success(a,e)}},30);e.value=""};e("upload-mobile",function(e){var a=new u(e=e||{});a.init()})});