layui.link("./script/systemProcessSetting/systemProcessSetting.css");layui.define(["layer","element","form","qRouter","table","laypage","laytpl","config_constant"],function(t){var s=layui.layer;var e=layui.element;var a=layui.form;var i=layui.qRouter;var n=layui.table;var o=layui.laypage;var l=layui.laytpl;var r=layui.config_constant;var c={taskNumber:null,page:1,length:10};var d={systemProcess:function(t){var i="";var n=$("[id^='render-systemProcess']");var l="";n.empty();l+='<div class="systemProcessSetting">';l+='<div id="systemProcess_body"></div>';l+='<div id="demo7"></div>';l+='<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">';l+="</fieldset>";l+="</div>";n.append(l);function u(){var t=$("#systemProcess_body");var n="";t.empty();$.ajax({type:"post",async:false,data:JSON.stringify(c),contentType:"application/json; charset=utf-8",url:r.URL_HEADER+"/after-task/select",success:function(o){i=o.count;n+='<div class="systemProcess_btn">';n+='<a class="layui-btn layui-btn-normal systemProcessSetting_add">新增任务</a>';n+='<a class="layui-btn layui-btn-normal systemProcessSetting_delete">删除任务</a>';n+='<input id="systemProcessSetting_search" type="text" name="title" required  lay-verify="required" placeholder="请输入搜索内容" autocomplete="off" class="layui-input">';n+='<a class="layui-btn layui-btn-normal systemProcessSetting_search">搜索</a>';n+="</div>";n+='<div class="systemProcessSetting_contain systemProcess_contain">';n+="<ul>";n+="<li>";n+="<div>&nbsp;</div>";n+="<div>任务号</div>";n+="<div>流程</div>";n+="<div>执行状态</div>";n+="<div>执行时间</div>";n+="<div>备注</div>";n+="<div>操作</div>";n+="</li>";$.each(o.data,function(t,s){n+='<li class="systemProcessSetting_list" data_process="'+s.id+'">';n+="<div>"+(t+1)+"</div>";n+='<div><i class="layui-icon" style="font-size: 16px; color: #7d7d85;">&#xe623;</i><i class="layui-icon layui_icon_second" style="font-size: 16px; color: #7d7d85;">&#xe622;</i>'+s.taskNumber+"</div>";n+="<div>"+(s.workflowName!=null?s.workflowName:"&nbsp;")+"</div>";if(s.stepStatus==0){n+="<div>等待执行</div>"}if(s.stepStatus==1){n+="<div>正在执行</div>"}if(s.stepStatus==2){n+="<div>已完成</div>"}if(s.stepStatus==5){n+="<div>执行失败</div>"}n+="<div>"+(s.startTimeString?s.startTimeString:"&nbsp;")+"</div>";n+="<div>"+(s.taskComment!=""?s.taskComment:"&nbsp;")+"<p>"+s.taskComment+"</p></div>";n+="<div>";if(s.stepStatus==0){n+='<a accessKey="1" id="'+s.id+'" class="layui-btn start_execution layui-btn-sm systemProcess_Start">开始执行</a>'}else{n+='<a accessKey="1" id="'+s.id+'" class="layui-btn start_execution layui-btn-sm layui-btn-disabled systemProcess_Start">开始执行</a>'}n+='<a href="'+s.stepLogPath+'" class="layui-btn layui-btn-sm layui-btn-primary systemProcess_viewlog">查看日志</a>';n+="</div>";n+="<ul>";$.each(s.afterTasks,function(t,e){n+='<li class="systemProcessSetting_list_ul_li">';n+="<div>&nbsp;</div>";n+='<div><i class="layui-icon" style="font-size: 16px; color: #7d7d85;">&#xe63c;</i>'+e.stepName+"</div>";n+="<div>"+(e.workflowName!=null?e.workflowName:"&nbsp;")+"</div>";if(e.stepStatus==0){n+="<div>等待执行</div>"}if(e.stepStatus==1){n+="<div>正在执行</div>"}if(e.stepStatus==2){n+="<div>已完成</div>"}if(e.stepStatus==5){n+="<div>执行失败</div>"}n+="<div>"+(e.startTimeString?e.startTimeString:"&nbsp;")+"</div>";n+="<div>"+(e.taskComment!=""?e.taskComment:"&nbsp;")+"<p>"+e.taskComment+"</p></div>";n+='<div class="systemProcess_action">';if(s.stepStatus==0){n+='<a accessKey="2" id="'+e.id+'" class="systemProcess_actionStart layui-btn start_execution layui-btn-sm  systemProcess_Start">开始执行</a>'}else{if(e.stepStatus==5){n+='<a accessKey="2" id="'+e.id+'" class="systemProcess_actionStart layui-btn start_execution layui-btn-sm  systemProcess_Start">开始执行</a>'}else{n+='<a  accessKey="2" id="'+e.id+'" class="systemProcess_actionStart systemProcess_linkvaluestepstatus layui-btn-disabled layui-btn start_execution layui-btn-sm systemProcess_Start">开始执行</a>'}}n+='<a href="'+e.stepLogPath+'" class="layui-btn layui-btn-primary layui-btn-sm systemProcess_viewlog">查看日志</a>';n+="</div>";n+="</li>"});n+="</ul>";n+="</li>"});n+="</ul>";n+="</div>";t.append(n);$.each(o.data,function(t,s){$.each(s.afterTasks,function(t,e){$("#"+e.id).data("taskPerform",e.taskPerform);if(s.taskPerform==false){$("#"+e.id).data("linkvaluestepstatus",e.stepStatus)}})});var l=$(".systemProcessSetting_contain").children().children(".systemProcessSetting_list");var u=$(".systemProcess_linkvaluestepstatus");$.each(u,function(t,s){var e=$(s).data("linkvaluestepstatus");if(e==1){$(s).parent().parent().siblings().children(".systemProcess_action").children(".systemProcess_actionStart").addClass("layui-btn-disabled");$(s).addClass("layui-btn-disabled")}if(e==2){$(s).parent().parent().next().children(".systemProcess_action").children(".systemProcess_actionStart").removeClass("layui-btn-disabled");$(s).parent().parent().next().siblings().children(".systemProcess_action").children(".systemProcess_actionStart").addClass("layui-btn-disabled")}});var y="";$(".systemProcessSetting_list .layui-icon").on("click",function(){$(this).toggleClass("systemProcessSetting_arrow");$(this).parent().parent().children("ul").toggle()});$(".systemProcessSetting_list").on("click",function(){$(this).parent().children(".systemProcessSetting_list").css("background","#fff");$(this).css("background","#1e9fff");var t=$(this).attr("data_process");$.each(o.data,function(s,e){if(t==e.id){y=e}})});$(".systemProcessSetting_list ul").on("click",function(t){t.stopPropagation()});$("#systemProcessSetting_search").keypress(function(t){if(t.which==13){p()}});$(".systemProcessSetting_search").on("click",function(){p()});function p(){c.taskNumber=$("#systemProcessSetting_search")["0"].value;d.systemProcess()}var f="";var m={id:"",taskNumber:"",taskPath:"",taskPerform:false,operateUser:$.localStorage.getItem("userId"),afterTasks:[{id:"",parentId:""}]};$(".start_execution").on("click",function(){if($(this).hasClass("layui-btn-disabled")){s.alert("该任务已开启，请勿重复开启")}else{f=$(this)["0"].id;if($(this)["0"].accessKey=="1"){$.each(o.data,function(t,s){if(f==s.id){m.id=s.id;m.taskNumber=s.taskNumber;m.taskPath=s.taskPath;m.taskPerform=true;m.operateUser=$.localStorage.getItem("id");m.afterTasks[0].id=s.afterTasks[0].id;m.afterTasks[0].parentId=s.id}})}else{if($(this).data("taskPerform")==true){var t=$(this).data("taskPerform");$.each(o.data,function(s,e){$.each(e.afterTasks,function(s,a){if(f==a.id){m.id=e.id;m.taskNumber=e.taskNumber;m.taskPath=e.taskPath;m.taskPerform=t;m.operateUser=$.localStorage.getItem("id");m.afterTasks[0].id=a.id;m.afterTasks[0].parentId=e.id}})})}else{$.each(o.data,function(t,s){$.each(s.afterTasks,function(t,e){if(f==e.id){m.id=s.id;m.taskNumber=s.taskNumber;m.taskPath=s.taskPath;m.taskPerform=false;m.operateUser=$.localStorage.getItem("id");m.afterTasks[0].id=e.id;m.afterTasks[0].parentId=s.id}})})}}v($(this))}});function v(t){s.confirm("确认要执行该条任务吗?",{btn:["确定","取消"]},function(){$.ajax({type:"post",data:JSON.stringify(m),contentType:"application/json; charset=utf-8",url:r.URL_HEADER+"/after-task/execute",success:function(t){if(t.code==0){d.systemProcess();s.alert("执行成功")}else{s.alert("执行失败")}}})},function(){s.closeAll()})}var k="";var b="";var P="";$.ajax({type:"get",async:false,url:r.URL_HEADER+"/task-workflow/find",success:function(t){b=t}});$.ajax({type:"get",async:false,url:r.URL_HEADER+"/task-path/find",success:function(t){P=t}});function _(){k="";k+='<div class="systemProcessSetting_pop systemProcess_pop">';k+='<div class="systemProcessSetting_pop_contain">';k+="<p>";k+="<span>任&nbsp;&nbsp;务&nbsp;&nbsp;号：</span>";k+='<input class="systemProcessSetting_name" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">';k+="</p>";k+='<p class="layui-form">';k+="<span>选择流程：</span>";k+='<select name="city" lay-verify="required">';k+='<option value=""></option>';$.each(b.data,function(t,s){k+='<option value="'+s.id+'">'+s.workflow_name+"</option>"});k+="</select>";k+="</p>";k+='<p class="layui-form">';k+="<span>执行路径：</span>";k+='<select name="city" lay-verify="required">';k+='<option value=""></option>';$.each(P.data,function(t,s){k+='<option title="'+s.id+'">'+s.taskPath+"</option>"});k+="</select>";k+="</p>";k+="<p>";k+='<span class="systemProcessSetting_pop_contain">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：</span>';k+='<input class="systemProcessSetting_Remarks" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">';k+="</p>";k+='<div class="systemProcessSetting_pop_button systemProcess_pop_button">';k+='<button class="layui-btn layui-btn-normal systemProcessSetting_pop_cancel">取消</button>';k+='<button class="layui-btn layui-btn-normal layui-btn-normal systemProcessSetting_pop_save">保存</button>';k+="</div>";k+="</div>";k+="</div>"}function g(){_();s.open({title:"新增任务",type:1,skin:"layui-layer-taskSkin",area:["480px","380px"],content:k,closeBtn:0,shadeClose:true,success:function(t,i){e.render();a.render();var n="";var o="";var l="";$(".layui-anim-upbit dd").on("click",function(){var t=$(this).parents(".layui-form").children("span")["0"].innerText;if(t=="选择流程："){n=$(this).attr("lay-value");$.each(b.data,function(t,s){if(n==s.id){n=s}})}else{l=$(this)["0"].innerText}});$(".systemProcessSetting_pop_cancel").on("click",function(){s.closeAll()});$(".systemProcessSetting_pop_save").on("click",function(){if($(".systemProcessSetting_name")["0"].value==""){s.open({title:"温馨提示",content:"请输入任务号"})}else if(n==""){s.open({title:"温馨提示",content:"请选择流程"})}else if(l==""){s.open({title:"温馨提示",content:"请选择执行路径"})}else{var t={workflowId:n.id,afterTask:{taskNumber:$(".systemProcessSetting_name")["0"].value,taskComment:$(".systemProcessSetting_Remarks")["0"].value,taskPath:l,createUser:$.localStorage.getItem("userId"),modifyUser:$.localStorage.getItem("userId"),workflowName:n.workflow_name,workflowType:n.workflow_type}};var e=s.load(2,{shade:[.1,"#fff"]});$.ajax({type:"post",data:JSON.stringify(t),contentType:"application/json; charset=utf-8",url:r.URL_HEADER+"/after-task/add",success:function(t){if(t.code==0){s.close(e);s.alert("添加成功");d.systemProcess()}else{s.close(e);s.alert(t.message)}},error:function(t){s.close(e);s.alert("添加失败")}});s.closeAll()}})}})}$(".systemProcessSetting_add").on("click",function(){g()});$(".systemProcessSetting_delete").on("click",function(){if(y!=""){S()}else{s.open({title:"删除提示",skin:"layui-layer-taskSkin",content:"请选择要删除的任务"})}});function S(){s.confirm("确定要删除这条数据吗?",{btn:["删除","取消"]},function(){var t=[y.id];var e=s.load(2,{shade:[.1,"#fff"]});$.ajax({type:"post",data:JSON.stringify(t),contentType:"application/json; charset=utf-8",url:r.URL_HEADER+"/after-task/delete",success:function(t){if(t.code==0){s.close(e);s.alert("删除成功");d.systemProcess()}else{s.close(e);s.alert("删除失败")}}})},function(){s.closeAll()})}}})}u();o.render({elem:"demo7",count:i,layout:["count","prev","page","next","limit","skip"],limits:[10,20,30],jump:function(t,s){if(!s){c.page=t.curr;c.length=t.limit;u()}}})}};t("systemProcess",d)});