layui.link("./script/systemProcessSetting/systemProcessSetting.css");layui.define(["layer","element","form","qRouter","table","laypage","laytpl","config_constant"],function(e){var t=layui.layer;var s=layui.element;var i=layui.form;var n=layui.qRouter;var a=layui.table;var o=layui.laypage;var l=layui.laytpl;var c=layui.config_constant;var r={workflowName:null,page:1,length:10};var p={systemProcessSetting:function(e){var n=$("[id^='render-systemProcessSetting']");n.empty();var a="";a+='<div class="systemProcessSetting">';a+='<div id="systemProcessSetting_body"></div>';a+='<div id="demo7"></div>';a+='<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">';a+="</fieldset>";a+="</div>";n.append(a);var l="";function u(){var e=$("#systemProcessSetting_body");var n="";e.empty();$.ajax({type:"post",async:false,data:JSON.stringify(r),contentType:"application/json; charset=utf-8",url:c.URL_HEADER+"/task-workflow/select",success:function(a){l=a.count;n+='<div class="systemProcessSetting_btn">';n+='<a class="layui-btn layui-btn-normal systemProcessSetting_add">新增</a>';n+='<a class="layui-btn layui-btn-normal systemProcessSetting_change" style="display:none;">修改</a>';n+='<a class="layui-btn layui-btn-normal systemProcessSetting_delete">删除</a>';n+='<input id="systemProcessSetting_search" type="text" name="title" required  lay-verify="required" placeholder="请输入搜索内容" autocomplete="off" class="layui-input">';n+='<a class="layui-btn layui-btn-normal systemProcessSetting_search">搜索</a>';n+="</div>";n+='<div class="systemProcessSetting_contain">';n+="<ul>";n+="<li>";n+="<div>序号</div>";n+="<div>流程名称</div>";n+="<div>流程类型</div>";n+="<div>创建时间</div>";n+="<div>创建人</div>";n+="<div>备注</div>";n+="</li>";$.each(a.data,function(e,t){n+='<li class="systemProcessSetting_list" data_process="'+t.id+'">';n+="<div>"+(e+1)+"</div>";n+='<div><i class="layui-icon" style="font-size: 16px; color: #7d7d85;">&#xe623;</i><i class="layui-icon layui_icon_second" style="font-size: 16px; color: #7d7d85;">&#xe622;</i>'+t.workflow_name+"</div>";n+="<div>"+t.workflow_type+"</div>";n+="<div>"+t.create_time+"</div>";n+="<div>"+t.user_name+"</div>";n+="<div>"+(t.workflow_comment!=""?t.workflow_comment:"&nbsp;")+"<p>"+t.workflow_comment+"</p></div>";n+="<ul>";$.each(t.afterSteps,function(e,t){n+='<li class="systemProcessSetting_list_ul_li">';n+="<div>&nbsp;</div>";n+='<div><i class="layui-icon" style="font-size: 16px; color: #7d7d85;">&#xe63c;</i>'+(t.step_name!=null||t.step_name!=""?t.step_name:"&nbsp;")+"</div>";n+="<div>"+(t.step_type!=null||t.step_type!=""?t.step_type:"&nbsp;")+"</div>";n+="<div>"+(t.create_time!=null||t.create_time!=""?t.create_time:"&nbsp;")+"</div>";n+="<div>"+(t.user_name!=""?t.user_name:"&nbsp;")+"</div>";n+="<div>"+(t.step_comment!=""?t.step_comment:"&nbsp;")+"<p>"+t.step_comment+"</p></div>";n+="</li>"});n+="</ul>";n+="</li>"});n+="</ul>";n+="</div>";e.append(n);var o="";var u="";$(".systemProcessSetting_list .layui-icon").on("click",function(){$(this).toggleClass("systemProcessSetting_arrow");$(this).parent().parent().children("ul").toggle()});$(".systemProcessSetting_list").on("click",function(){$(this).parent().children("li").css("background","#fff");$(this).css("background","#1e9fff");var e=$(this).attr("data_process");$.each(a.data,function(t,s){if(e==s.id){o=s}})});$(".systemProcessSetting_list ul").on("click",function(e){e.stopPropagation()});$("#systemProcessSetting_search").keypress(function(e){if(e.which==13){d()}});$(".systemProcessSetting_search").on("click",function(){d()});function d(){r.workflowName=$("#systemProcessSetting_search")["0"].value;p.systemProcessSetting()}var y="";var m="";var f=[];$.ajax({type:"get",async:false,url:c.URL_HEADER+"/task-step/find",success:function(e){m=e}});function v(){y="";y+='<div class="systemProcessSetting_pop">';y+='<div class="systemProcessSetting_pop_contain">';y+="<p>";y+='<span class="systemProcessSetting_pop_contain">流程名称：</span>';y+='<input class="systemProcessSetting_name" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">';y+="</p>";y+="<p>";y+='<span class="systemProcessSetting_pop_contain">流程类型：</span>';y+='<input class="systemProcessSetting_type" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">';y+="</p>";y+="<p>";y+='<span class="systemProcessSetting_pop_contain">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：</span>';y+='<input class="systemProcessSetting_Remarks" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">';y+="</p>";y+='<div class="choose_link">';y+='<p>选择环节：<i class="layui-icon systemProcessSetting_pop_del" style="font-size: 30px; color: #666666;">&#xe640;</i>  </p>';y+='<div class="choose_link_left">';$.each(m.data,function(e,t){y+='<p><input type="checkbox" name="'+t.id+'" value="'+t.stepName+'" lay-skin="primary">'+t.stepName+"</p>"});y+="</div>";y+='<div class="choose_link_center">';y+='<button class="layui-btn layui-btn-normal layui-btn-sm systemProcessSetting_pop_add">添加环节</button>';y+="</div>";y+='<div class="choose_link_right">';y+="</div>";y+="</div>";y+='<div class="systemProcessSetting_pop_button">';y+='<button class="layui-btn layui-btn-primary layui-btn-sm systemProcessSetting_pop_cancel">取消</button>';y+='<button class="layui-btn layui-btn-normal layui-btn-sm systemProcessSetting_pop_save">保存</button>';y+="</div>";y+="</div>";y+="</div>"}function _(){v();t.open({title:u,type:1,skin:"layui-layer-taskSkin",area:["530px","auto"],content:y,closeBtn:0,shadeClose:true,success:function(e,n){s.render();i.render();var a=$(".choose_link_right").dad();a.addDropzone(".systemProcessSetting_pop_del",function(e){e.remove()});$(".systemProcessSetting_pop_add").on("click",function(){if($(".choose_link_left input:checkbox:checked").length>0){f=[];$.each($(".dad-draggable-area"),function(e,t){var s={};s.stepId=t.title;s.value=t.innerText;f.push(s)});$.each($(".choose_link_left input:checkbox:checked"),function(e,t){var s={};s.stepId=t.name;s.value=t.value;f.push(s)});var e="";$.each(f,function(t,s){e+='<div title="'+s.stepId+'"><span>'+s.value+"</span></div>"});$(".choose_link_right").html(e);var s=$(".choose_link_right").dad();s.addDropzone(".systemProcessSetting_pop_del",function(e){e.remove()})}else{t.open({title:"温馨提示",content:"请选择环节"})}});$(".systemProcessSetting_pop_cancel").on("click",function(){f=[];t.closeAll()});$(".systemProcessSetting_pop_save").on("click",function(){if($(".systemProcessSetting_name")["0"].value==""){t.open({title:"温馨提示",content:"请输入流程名称"})}else if($(".systemProcessSetting_type")["0"].value==""){t.open({title:"温馨提示",content:"请输入流程类型"})}else if($(".choose_link_right")["0"].children.length<=0){t.open({title:"温馨提示",content:"请添加环节"})}else{var e={afterTaskWorkflow:{id:null,workflowType:$(".systemProcessSetting_type")["0"].value,workflowName:$(".systemProcessSetting_name")["0"].value,workflowComment:$(".systemProcessSetting_Remarks")["0"].value,createUser:$.localStorage.getItem("userId"),createTime:null,modifyUser:$.localStorage.getItem("userId"),modifyTime:null},stepWorkflows:[]};$.each($(".choose_link_right")["0"].children,function(t,s){var i={workflowId:null,stepId:s.title,stepSequence:t+1,createUser:null,createTime:null,modifyUser:null,modifyTime:null};e.stepWorkflows.push(i)});var s=t.load(2,{shade:[.1,"#fff"]});$.ajax({type:"post",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",url:c.URL_HEADER+"/task-workflow/save",success:function(e){if(e.code==0){t.alert("添加成功");t.close(s);p.systemProcessSetting()}else{t.close(s);t.alert(e.message)}f=[]},error:function(e){t.close(s);t.alert("添加失败")}});t.closeAll()}})}})}$(".systemProcessSetting_add").on("click",function(){f=[];u="新增流程";_()});$(".systemProcessSetting_change").on("click",function(){if(o!=""){u="修改流程";_()}else{t.open({title:"温馨提示",skin:"layui-layer-taskSkin",content:"请选择要修改环节的流程"})}});$(".systemProcessSetting_delete").on("click",function(){if(o!=""){t.confirm("确定要删除这条数据吗?",{btn:["删除","取消"]},function(){var e=[o.id];var s=t.load(2,{shade:[.1,"#fff"]});$.ajax({type:"post",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",url:c.URL_HEADER+"/task-workflow/delete",success:function(e){if(e.code==0){t.close(s);t.alert("删除成功");p.systemProcessSetting()}else{t.close(s);t.alert("删除失败,请重新删除")}},error:function(e){t.close(s);t.alert("删除失败,请重新删除")}})},function(){t.closeAll()})}else{t.open({title:"删除提示",skin:"layui-layer-taskSkin",content:"请选择要删除的流程"})}})}})}u();o.render({elem:"demo7",count:l,layout:["count","prev","page","next","limit","skip"],limits:[10,20,30],jump:function(e,t){if(!t){r.page=e.curr;r.length=e.limit;u()}}})}};e("systemProcessSetting",p)});