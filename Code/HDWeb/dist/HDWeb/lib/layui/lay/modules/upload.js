layui.define("layer",function(e){"use strict";var i=layui.$,t=layui.layer,n=layui.hint(),a=layui.device(),o={config:{},set:function(e){var t=this;t.config=i.extend({},t.config,e);return t},on:function(e,i){return layui.onevent.call(this,r,e,i)}},l=function(){var e=this;return{upload:function(i){e.upload.call(e,i)},config:e.config}},r="upload",u=".layui-upload",f="layui-this",c="layui-show",s="layui-hide",p="layui-disabled",d="layui-upload-file",m="layui-upload-form",h="layui-upload-iframe",v="layui-upload-choose",g="layui-upload-drag",y=function(e){var t=this;t.config=i.extend({},t.config,o.config,e);t.render()};y.prototype.config={accept:"images",exts:"",auto:true,bindAction:"",url:"",field:"file",method:"post",data:{},drag:true,size:0,number:0,multiple:false};y.prototype.render=function(e){var t=this,e=t.config;e.elem=i(e.elem);e.bindAction=i(e.bindAction);t.file();t.events()};y.prototype.file=function(){var e=this,t=e.config,n=e.elemFile=i(['<input class="'+d+'" type="file" name="'+t.field+'"',t.multiple?" multiple":"",">"].join("")),o=t.elem.next();if(o.hasClass(d)||o.hasClass(m)){o.remove()}if(a.ie&&a.ie<10){t.elem.wrap('<div class="layui-upload-wrap"></div>')}e.isFile()?(e.elemFile=t.elem,t.field=t.elem[0].name):t.elem.after(n);if(a.ie&&a.ie<10){e.initIE()}};y.prototype.initIE=function(){var e=this,t=e.config,n=i('<iframe id="'+h+'" class="'+h+'" name="'+h+'" frameborder="0"></iframe>'),a=i(['<form target="'+h+'" class="'+m+'" method="'+t.method,'" key="set-mine" enctype="multipart/form-data" action="'+t.url+'">',"</form>"].join(""));i("#"+h)[0]||i("body").append(n);if(!t.elem.next().hasClass(h)){e.elemFile.wrap(a);t.elem.next("."+h).append(function(){var e=[];layui.each(t.data,function(i,t){e.push('<input type="hidden" name="'+i+'" value="'+t+'">')});return e.join("")}())}};y.prototype.msg=function(e){return t.msg(e,{icon:2,shift:6})};y.prototype.isFile=function(){var e=this.config.elem[0];if(!e)return;return e.tagName.toLocaleLowerCase()==="input"&&e.type==="file"};y.prototype.preview=function(e){var i=this;if(window.FileReader){layui.each(i.chooseFiles,function(i,t){var n=new FileReader;n.readAsDataURL(t);n.onload=function(){e&&e(i,t,this.result)}})}};y.prototype.upload=function(e,t){var n=this,o=n.config,l=n.elemFile[0],r=function(){var t=0,a=0,r=e||n.files||n.chooseFiles||l.files,u=function(){if(o.multiple&&t+a===n.fileLength){typeof o.allDone==="function"&&o.allDone({total:n.fileLength,successful:t,aborted:a})}};layui.each(r,function(e,l){var r=new FormData;r.append(o.field,l);layui.each(o.data,function(e,i){r.append(e,i)});i.ajax({url:o.url,type:o.method,data:r,contentType:false,processData:false,dataType:"json",success:function(i){t++;f(e,i);u()},error:function(){a++;n.msg("请求上传接口出现异常");c(e);u()}})})},u=function(){var e=i("#"+h);n.elemFile.parent().submit();clearInterval(y.timer);y.timer=setInterval(function(){var i,t=e.contents().find("body");try{i=t.text()}catch(e){n.msg("获取上传后的响应信息出现异常");clearInterval(y.timer);c()}if(i){clearInterval(y.timer);t.html("");f(0,i)}},30)},f=function(e,i){n.elemFile.next("."+v).remove();l.value="";if(typeof i!=="object"){try{i=JSON.parse(i)}catch(e){i={};return n.msg("请对上传接口返回有效JSON")}}typeof o.done==="function"&&o.done(i,e||0,function(e){n.upload(e)})},c=function(e){if(o.auto){l.value=""}typeof o.error==="function"&&o.error(e||0,function(e){n.upload(e)})},s=o.exts,p,d=function(){var i=[];layui.each(e||n.chooseFiles,function(e,t){i.push(t.name)});return i}(),m={preview:function(e){n.preview(e)},upload:function(e,i){var t={};t[e]=i;n.upload(t)},pushFile:function(){n.files=n.files||{};layui.each(n.chooseFiles,function(e,i){n.files[e]=i});return n.files}},g=function(){if(t==="choose"){return o.choose&&o.choose(m)}o.before&&o.before(m);if(a.ie){return a.ie>9?r():u()}r()};d=d.length===0?l.value.match(/[^\/\\]+\..+/g)||[]||"":d;if(d.length===0)return;switch(o.accept){case"file":if(s&&!RegExp("\\w\\.("+s+")$","i").test(escape(d))){n.msg("选择的文件中包含不支持的格式");return l.value=""}break;case"video":if(!RegExp("\\w\\.("+(s||"avi|mp4|wma|rmvb|rm|flash|3gp|flv")+")$","i").test(escape(d))){n.msg("选择的视频中包含不支持的格式");return l.value=""}break;case"audio":if(!RegExp("\\w\\.("+(s||"mp3|wav|mid")+")$","i").test(escape(d))){n.msg("选择的音频中包含不支持的格式");return l.value=""}break;default:layui.each(d,function(e,i){if(!RegExp("\\w\\.("+(s||"jpg|png|gif|bmp|jpeg$")+")","i").test(escape(i))){p=true}});if(p){n.msg("选择的图片中包含不支持的格式");return l.value=""}break}n.fileLength=function(){var i=0,t=e||n.files||n.chooseFiles||l.files;layui.each(t,function(){i++});return i}();if(o.number&&n.fileLength>o.number){return n.msg("同时最多只能上传的数量为："+o.number)}if(o.size>0&&!(a.ie&&a.ie<10)){var F;layui.each(n.chooseFiles,function(e,i){if(i.size>1024*o.size){var t=o.size/1024;t=t>=1?Math.floor(t)+(t%1>0?t.toFixed(1):0)+"MB":o.size+"KB";l.value="";F=t}});if(F)return n.msg("文件不能超过"+F)}g()};y.prototype.events=function(){var e=this,t=e.config,o=function(i){e.chooseFiles={};layui.each(i,function(i,t){var n=(new Date).getTime();e.chooseFiles[n+"-"+i]=t})},l=function(i,n){var a=e.elemFile,o=i.length>1?i.length+"个文件":(i[0]||{}).name||(a[0].value.match(/[^\/\\]+\..+/g)||[])||"";if(a.next().hasClass(v)){a.next().remove()}e.upload(null,"choose");if(e.isFile()||t.choose)return;a.after('<span class="layui-inline '+v+'">'+o+"</span>")};t.elem.off("upload.start").on("upload.start",function(){var a=i(this),o=a.attr("lay-data");if(o){try{o=new Function("return "+o)();e.config=i.extend({},t,o)}catch(e){n.error("Upload element property lay-data configuration item has a syntax error: "+o)}}e.config.item=a;e.elemFile[0].click()});if(!(a.ie&&a.ie<10)){t.elem.off("upload.over").on("upload.over",function(){var e=i(this);e.attr("lay-over","")}).off("upload.leave").on("upload.leave",function(){var e=i(this);e.removeAttr("lay-over")}).off("upload.drop").on("upload.drop",function(n,a){var r=i(this),u=a.originalEvent.dataTransfer.files||[];r.removeAttr("lay-over");o(u);if(t.auto){e.upload(u)}else{l(u)}})}e.elemFile.off("upload.change").on("upload.change",function(){var i=this.files||[];o(i);t.auto?e.upload():l(i)});t.bindAction.off("upload.action").on("upload.action",function(){e.upload()});if(t.elem.data("haveEvents"))return;e.elemFile.on("change",function(){i(this).trigger("upload.change")});t.elem.on("click",function(){if(e.isFile())return;i(this).trigger("upload.start")});if(t.drag){t.elem.on("dragover",function(e){e.preventDefault();i(this).trigger("upload.over")}).on("dragleave",function(e){i(this).trigger("upload.leave")}).on("drop",function(e){e.preventDefault();i(this).trigger("upload.drop",e)})}t.bindAction.on("click",function(){i(this).trigger("upload.action")});t.elem.data("haveEvents",true)};o.render=function(e){var i=new y(e);return l.call(i)};e(r,o)});